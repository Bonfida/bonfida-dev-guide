<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Checks on third-party state - The Bonfida Development Guide</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded "><a href="01_Getting_started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="02_Writing_a_program.html"><strong aria-hidden="true">2.</strong> Writing a program</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="02.01_Encoding_state.html"><strong aria-hidden="true">2.1.</strong> Encoding state</a></li><li class="chapter-item expanded "><a href="02.02_VestingContract.html"><strong aria-hidden="true">2.2.</strong> Writing state: VestingContract</a></li><li class="chapter-item expanded "><a href="02.03_Instruction_create.html"><strong aria-hidden="true">2.3.</strong> Writing an instruction: create</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="02.03.01_Required_accounts.html"><strong aria-hidden="true">2.3.1.</strong> Required Accounts</a></li><li class="chapter-item expanded "><a href="02.03.02_Parameters.html"><strong aria-hidden="true">2.3.2.</strong> Parameters</a></li><li class="chapter-item expanded "><a href="02.03.03_Instruction_logic.html"><strong aria-hidden="true">2.3.3.</strong> Instruction Logic</a></li><li class="chapter-item expanded "><a href="02.03.04_Instruction_create_patch.html"><strong aria-hidden="true">2.3.4.</strong> Patching a vulnerability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="02.03.04.01_Instruction_data.html"><strong aria-hidden="true">2.3.4.1.</strong> Instruction data</a></li><li class="chapter-item expanded "><a href="02.03.04.02_Account_data.html"><strong aria-hidden="true">2.3.4.2.</strong> Account data</a></li><li class="chapter-item expanded "><a href="02.03.04.03_Implementing_checks_on_third-party_state.html" class="active"><strong aria-hidden="true">2.3.4.3.</strong> Checks on third-party state</a></li></ol></li><li class="chapter-item expanded "><a href="02.03.05_Conclusion.html"><strong aria-hidden="true">2.3.5.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><a href="02.04_Instruction_claim.html"><strong aria-hidden="true">2.4.</strong> Writing an instruction: claim</a></li><li class="chapter-item expanded "><a href="02.05_Integration_testing.html"><strong aria-hidden="true">2.5.</strong> Setting up integration testing</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Examples</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> FAQ</div></li><li class="chapter-item expanded affix "><li class="part-title">Using Bonfida tools</li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> utils</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> autobindings</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> autodoc</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> benchviz</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Bonfida Development Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Bonfida/bonfida-dev-guide/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementing-checks-on-third-party-state"><a class="header" href="#implementing-checks-on-third-party-state">Implementing checks on third-party state</a></h1>
<p>In the above discussion, we have determined that our vault should be owned by an account our program controls and can sign for.
This is where program-derived addresses (PDAs) come into play.</p>
<h2 id="aside-what-are-program-derived-addresses-pdas"><a class="header" href="#aside-what-are-program-derived-addresses-pdas">Aside: what are Program-Derived Addresses (PDAs)?</a></h2>
<p>PDAs are Solana's solution for a recurring generic problem in program design : how can our program <em>own</em> anything of value?
Conventionally, owning an asset on a blockchain means controlling a private key the public key of which is set as its <em>owner</em>.
Then, users can sign transactions to authorize operations on assets they own.
The key to all of this is that the private key is only known to its owner.</p>
<p>Sometimes, we need a program to own something in the same way that a user does.
However, any information a program has access to is available to anyone, so we can't really give a private key to our program.
What we need is a public key which isn't tied to a private key, but instead to a particular program.
This is precisely what PDAs are.</p>
<p>A PDA is uniquely derived from an array of <em>seeds</em>.
To generate a PDA, we can use one of two methods <code>Pubkey::find_program_address</code>, or <code>Pubkey::create_program_address</code>.
The difference between the two is that <code>create_program_address</code> needs <em>valid</em> seeds which generate a valid PDA.
A valid PDA is a Pubkey which we're sure doesn't have a private key.
It lies outside the <code>ed25519</code> curve used by Solana.
<code>find_program_address</code> will take a seed array and find a <code>u8</code> to add to the seed array such that the resulting array is a valid PDA seed.
We call this <code>u8</code> the <code>signer_nonce</code>.</p>
<p>We can relate the two methods:</p>
<pre><code class="language-rust noplayground">let seeds: &amp;[u8] = &amp;[...];
let (k, nonce) = Pubkey::find_program_address(&amp;[seeds], program_id).unwrap();
let k2 = Pubkey::create_program_address(&amp;[seeds, &amp;[signer_nonce]]).unwrap();
// k and k2 will be the same
assert_eq!(k, k2);
</code></pre>
<p>In general, <code>find_program_address</code> can be relatively inefficient: it loops over potential nonces until it finds a valid one.
The real issue is that the length of this loop is quite unpredictable.
In most cases, it will be very short.
This means that the entirety of your testing scenarios can only test for short loops, and edge cases can show up in production later down the line.
Therefore, as a general rule of thumb, <code>find_program_address</code> should be avoided on-chain because it consumes an unreliable amount of compute budget.
There are exceptions to this rule, especially when PDAs are used as a mapping function.
This is why we ask the user to provide a <code>signer_nonce</code>: <code>find_program_address</code> is executed off-chain.</p>
<p>A PDA's seeds serve a similar purpose to a private key.
When a program needs to sign for a PDA, it uses the PDA's seeds in a call to <code>invoke_signed</code>.
The runtime can then make sure that the PDA to sign for corresponds to those seeds and the calling program.</p>
<p>To add a layer of security, we want our vesting contract instances to be as compartmentalized as possible.
Therefore, we will use the <code>VestingContract</code> key as seeds.
Each instance already has its own vault, and this allows each contract to have its own separate signing authority.
The alternative to this is related to the idea of <em>central state</em>, which can be required by some use cases and is supported by <code>bonfida-utils</code>.</p>
<h2 id="writing-the-check_vault_account-method"><a class="header" href="#writing-the-check_vault_account-method">Writing the <code>check_vault_account</code> method</a></h2>
<p>Using the constraints we came up with by analyzing the <code>spl_token::Account</code> struct, we can add to <code>create.rs</code>:</p>
<pre><code class="language-rust noplayground">fn check_vault_account(
    vault: &amp;AccountInfo,
    program_id: &amp;Pubkey,
    contract_key: Pubkey,
    signer_nonce: u8,
) -&gt; Result&lt;(), ProgramError&gt; {
    // We parse the Account struct using the Solana-provided Pack trait
    let vault_account = spl_token::state::Account::unpack(&amp;vault.data.borrow())?;

    let vault_signer =
        Pubkey::create_program_address(&amp;[&amp;contract_key.to_bytes(), &amp;[signer_nonce]], program_id)?;
    let is_valid = vault_account.owner == vault_signer
        &amp;&amp; vault_account.amount == 0
        &amp;&amp; vault_account.delegate.is_none()
        &amp;&amp; vault_account.state == AccountState::Initialized
        &amp;&amp; vault_account.close_authority.is_none();
    if !is_valid {
        return Err(TokenVestingError::InvalidVaultAccount.into());
    }
    Ok(())
}
</code></pre>
<p>If the provided vault account is invalid, we return the custom <code>InvalidVaultAccount</code> error.
Let's define it in <code>error.rs</code> by modifying the <code>TokenVestingError</code> struct:</p>
<pre><code class="language-rust noplayground">#[derive(Clone, Debug, Error, FromPrimitive)]
pub enum TokenVestingError {
    #[error(&quot;This account is already initialized&quot;)]
    AlreadyInitialized,
    #[error(&quot;Data type mismatch&quot;)]
    DataTypeMismatch,
    #[error(&quot;Wrong account owner&quot;)]
    WrongOwner,
    #[error(&quot;Account is uninitialized&quot;)]
    Uninitialized,
    #[error(&quot;The provided vault account is invalid&quot;)]
    InvalidVaultAccount,
}
</code></pre>
<p>Our project does not compile at this point, and we need to edit <code>TokenVestingError</code>'s impl of the <code>PrintProgramError</code> trait in <code>entrypoint.rs</code>:</p>
<pre><code class="language-rust noplayground">impl PrintProgramError for TokenVestingError {
    fn print&lt;E&gt;(&amp;self)
    where
        E: 'static + std::error::Error + DecodeError&lt;E&gt; + PrintProgramError + FromPrimitive,
    {
        match self {
            TokenVestingError::AlreadyInitialized =&gt; {
                msg!(&quot;Error: This account is already initialized&quot;)
            }
            TokenVestingError::DataTypeMismatch =&gt; msg!(&quot;Error: Data type mismatch&quot;),
            TokenVestingError::WrongOwner =&gt; msg!(&quot;Error: Wrong account owner&quot;),
            TokenVestingError::Uninitialized =&gt; msg!(&quot;Error: Account is uninitialized&quot;),
            TokenVestingError::InvalidVaultAccount =&gt; {
                msg!(&quot;Error: The provided vault account is invalid&quot;)
            }
        }
    }
}
</code></pre>
<p>It might seem a bit redundant to have the same error message appear twice in our project.
However, doing it this way prevents our <code>PrintProgramError</code> implementation from having to use string formatting which is inefficient on-chain.
The last thing we want is our error messages to be buried under a <code>ComputationalBudgetExceeded</code> error.</p>
<p>Finally we just have to insert a call to <code>check_vault_account</code> in our <code>create</code> instruction's logic:</p>
<pre><code class="language-rust noplayground">check_vault_account(
    accounts.vault,
    program_id,
    *accounts.vesting_contract.key,
    signer_nonce,
)?;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="02.03.04.02_Account_data.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="02.03.05_Conclusion.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="02.03.04.02_Account_data.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="02.03.05_Conclusion.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
